import requests
from io import StringIO
import pandas as pd
import numpy as np
import requests
import argparse
from datetime import datetime, timedelta
from firebase import firebase
import time
import datetime
import json

url='https://happysorry-2c3e7.firebaseio.com/'

fb=firebase.FirebaseApplication(url)

a='0'
b='0'
c='0'
d='0'
e='0'
f='0'
g='0'
h='0'
ii='0'
jj='0'
k='0'
l='0'
m='0'
n='0'
o='0'
p='0'


def init(lst):
    global a,b,c,e,d,f,g,h,ii,jj,k,l,m,n,o,p
    a=lst['證券代號'].astype(str).values[0]
    b=lst["證券名稱"].astype(str).values[0]
    c=lst["成交股數"].astype(str).values[0]
    d=lst["成交筆數"].astype(str).values[0]
    e=lst["成交金額"].astype(str).values[0]
    f=lst["開盤價"].astype(str).values[0]
    g=lst["最高價"].astype(str).values[0]
    h=lst["最低價"].astype(str).values[0]
    ii=lst["收盤價"].astype(str).values[0]
    jj=lst["漲跌(+/-)"].astype(str).values[0]
    k=lst["漲跌價差"].astype(str).values[0]
    l=lst["最後揭示買價"].astype(str).values[0]
    m=lst["最後揭示買量"].astype(str).values[0]
    n=lst["最後揭示賣價"].astype(str).values[0]
    o=lst["最後揭示賣量"].astype(str).values[0]
    p=lst["本益比"].astype(str).values[0]
    

def addfire(classify):
    global a,b,c,e,d,f,g,h,ii,jj,k,l,m,n,o,p
    data = {'證券代號': a, '證券名稱': b, '成交股數': c,'成交筆數':d,'成交金額':e,'開盤價':f,'最高價':g,'最低價':h,'收盤價':ii,'漲跌':jj,'漲跌價差':k,'最後揭示買價':l,'最後揭示買量':m,'最後揭示賣價':n,'最後揭示賣量':o,'本益比':p}
    string="/{0}/{1}".format(str(classify),str(a))
    print(string,data)
    fb.post(string,data)
    
    
def deletefire():
    cl=['水泥','食品','塑膠','紡織','電機','電器電纜','化學','生技醫療','玻璃','造紙','鋼鐵','橡膠','汽車','半導體','電腦周邊','光電',
        '通信網路','電子零組件','電子通路','資訊服務','其他電子','營建','航運','觀光','金融','貿易百貨','油電燃氣','其他']
    for z in cl:
        fb.delete('',z)

    
#當日日期
datestr = datetime.date.today().today().strftime("%Y%m%d")
r = requests.post('http://www.twse.com.tw/exchangeReport/MI_INDEX?response=csv&date=' + datestr + '&type=ALL')
df = pd.read_csv(StringIO("\n".join([i.translate({ord(c): None for c in ' '}) 
for i in r.text.split('\n') 
    if len(i.split('",')) == 17 and i[0] != '='])), header=0)

for i in range(0,937):
    
    yes=0
    lst=df[i:i+1]
    try:
        global num
        
        num=lst['證券代號'].astype(int).values[0]
        ex=[1101,1102,1103,1104,1108,1109,1110,
            1201,1203,1210,1213,1215,1216,1217,1218,1219,1220,1225,1227,1229,1231,1232,1233,1234,1235,1236,1256,1702,1737,
            1301,1303,1304,1305,1307,1308,1309,1310,1312,1313,1314,1315,1319,1321,1323,1324,1326,1337,1339,1340,4306,
            1402,1409,1410,1413,1414,1416,1417,1418,1419,1423,1434,1439,1440,1441,1443,1444,1445,1446,1447,1449,1451,1452,1453,1454,1455,1456,1457,1459,1460,1463,1464,1465,1466,1467,1468,1469,1470,1472,1473,1474,1475,1476,1477,4414,4426,4438,
            1503,1504,1506,1507,1512,1513,1514,1515,1517,1519,1521,1522,1524,1525,1526,1527,1528,1529,1530,1531,1532,1533,1535,1536,1537,1538,1539,1540,1541,1558,1560,1568,1583,1589,1590,1592,2049,2228,2231,2236,2371,3167,4526,4532,4551,4552,4555,4557,4560,4562,4566,5288,6605,8222,8374,8996,
            1603,1604,1605,1608,1609,1611,1612,1614,1615,1616,1617,1618,1626,4930,
            1316,1704,1708,1709,1710,1711,1712,1713,1714,1717,1718,1721,1722,1723,1724,1725,1726,1727,1730,1732,1735,1773,1776,3708,4720,4722,4725,4739,4755,4763,4764,
            1598,1701,1707,1720,1731,1733,1734,1736,1760,1762,1783,1786,1789,3164,3705,4104,4106,4108,4119,4133,4137,4141,4142,4144,4148,4155,4164,4190,4737,4736,6452,6541,
            1802,1806,1809,1810,1817,
            1902,1903,1904,1905,1906,1907,1909,
            2002,2006,2007,2008,2009,2010,2012,2013,2014,2015,2017,2020,2022,2023,2024,2025,2027,2028,2029,2030,2031,2032,2033,2034,2038,2069,3004,5007,5538,9958,
            2101,2102,2103,2104,2105,2106,2107,2108,2109,2114,2115,6582,
            1338,2201,2204,2206,2207,2227,2239,2243,3346,
            1437,2302,2303,2311,2325,2329,2330,2337,2338,2342,2344,2351,2363,2369,2379,2388,2401,2408,2434,2436,2441,2449,2451,2454,2458,2481,3006,3014,3016,3034,3035,3041,3054,3094,3189,3257,3413,3443,3519,3532,3536,3545,3579,3583,3588,3661,3686,4919,4952,4968,5269,5285,5302,5471,6202,6239,6243,6257,6271,6415,6451,6525,6531,6533,6552,6573,8016,8081,8110,8131,8150,8261,8271,
            2301,2305,2324,2331,2352,2353,2356,2357,2362,2364,2365,2376,2377,2380,2382,2387,2395,2397,2399,2405,2417,2424,2425,2442,2465,3002,3005,3013,3017,3022,3046,3057,3060,3231,3416,3494,3515,3701,3706,4916,4938,5215,5258,5264,6117,6128,6166,6172,6206,6230,6235,6277,6414,6579,6591,8114,8163,8210,9912,
            2323,2340,2349,2374,2393,2406,2409,2426,2438,2448,2466,2475,2486,2489,2491,2499,3008,3019,3024,3031,3038,3049,3050,3051,3059,3149,3356,3383,3406,3437,3454,3481,3504,3514,3535,3557,3561,3576,3591,3622,3669,3673,3698,4934,4935,4942,4956,4960,4976,5234,5243,5259,5484,6116,6120,6131,6164,6168,6176,6209,6225,6226,6278,6289,6405,6431,6443,6456,6477,8072,8105,8215,
            2314,2321,2332,2345,2412,2419,2439,2444,2450,2455,2485,2496,2498,3025,3027,3045,3047,3062,3311,3380,3419,3596,3682,3694,3704,4904,4906,4977,4984,5388,6136,6142,6152,6216,6283,6285,6442,8011,8101,
            1471,1582,2059,2308,2313,2316,2327,2328,2355,2367,2368,2375,2383,2385,2392,2402,2413,2415,2420,2421,2428,2429,2431,2440,2443,2456,2457,2460,2462,2467,2472,2476,2478,2483,2484,2492,2493,3003,3011,3015,3021,3023,3026,3032,3037,3042,3044,3058,3090,3229,3296,3308,3321,3338,3376,3432,3501,3533,3550,3593,3605,3607,3645,3653,3679,4545,4912,4915,4927,4943,4958,4999,5469,6108,6115,6133,6141,6153,6155,6165,6191,6197,6205,6213,6224,6251,6269,6282,6412,6422,6449,8039,8046,8103,8213,8249,
            2347,2414,2430,2459,3010,3028,3033,3036,3048,3055,3209,3312,3528,3702,5434,6145,6189,6281,8070,8112,
            2427,2453,2468,2471,2480,3029,3130,4994,5203,6112,6183,6214,
            2312,2317,2354,2359,2360,2373,2390,2404,2423,2433,2461,2464,2474,2477,2482,2488,2495,2497,3018,3030,3043,3305,3450,3518,3617,3665,5225,6139,6192,6196,6201,6215,6409,8021,8201,
            1436,1438,1442,1805,1808,2501,2504,2505,2506,2509,2511,2515,2516,2520,2524,2527,2528,2530,2534,2535,2536,2537,2538,2539,2540,2542,2543,2545,2546,2547,2548,2597,2841,2923,3052,3056,3266,3703,5515,5519,5521,5522,5525,5531,5533,5534,6177,9906,9946,
            2208,2603,2605,2606,2607,2608,2609,2610,2611,2612,2613,2615,2617,2618,2630,2633,2634,2636,2638,2642,5607,5608,
	         2701,2702,2704,2705,2706,2707,2712,2722,2723,2727,2731,2739,2748,5706,8940,9943,
            2801,2809,2812,2816,2820,2823,2832,2834,2836,2838,2845,2849,2850,2851,2852,2855,2856,2867,2880,2881,2882,2883,2884,2885,2886,2887,2888,2889,2890,2891,2892,2897,5880,6005,6024,
            1432,2601,2614,2901,2903,2905,2906,2908,2910,2911,2912,2913,2915,2929,2936,2939,4807,5906,5907,8429,8443,8454,
	         2616,6505,8926,9908,9918,9926,9931,9937,
	         1262,1435,1516,2062,2348,2358,2514,2904,3040,4536,5284,5871,6184,6464,6504,6581,6625,8033,8341,8404,8411,8422,8427,8442,8463,8464,8466,8467,8473,8478,8480,8481,8488,8497,8499,9802,9902,9904,9905,9907,9910,9911,9914,9917,9919,9921,9924,9925,9927,9928,9929,9930,9933,9934,9935,9938,9939,9940,9941,9942,9944,9945,9955]
        for z in range(0,937):
            if num==ex[z]:
                if z <7:
                    init(lst)
                    addfire('水泥')
                    break

                elif z>=7 and z<29:
                    init(lst)
                    addfire('食品')
                    break
                
                elif z>=29 and z<52:
                    init(lst)
                    addfire('塑膠')
                    break
                
                elif z>=52 and z<98:
                    init(lst)
                    addfire('紡織')
                    break
                
                elif z>=98 and z<154:
                    init(lst)
                    addfire('電機')
                    break
                
                elif z>=154 and z<168:
                    init(lst)
                    addfire('電器電纜')
                    break
                
                elif z>=168 and z<199:
                    init(lst)
                    addfire('化學')
                    break
                
                elif z>=199 and z<231:
                    init(lst)
                    addfire('生技醫療')
                    break
                
                elif z>=231 and z<236:
                    init(lst)
                    addfire('玻璃')
                    break
                
                elif z>=236 and z<243:
                    init(lst)
                    addfire('造紙')
                    break
                
                elif z>=243 and z<274:
                    init(lst)
                    addfire('鋼鐵')
                    break
                elif z>=274 and z<286:
                    init(lst)
                    addfire('橡膠')
                    break
                elif z>=286 and z<295:
                    init(lst)
                    addfire('汽車')
                    break
                elif z>=295 and z<368:
                    init(lst)
                    addfire('半導體')
                    break
                elif z>=368 and z<427:
                    init(lst)
                    addfire('電腦周邊')
                    break
                elif z>=427 and z<499:
                    init(lst)
                    addfire('光電')
                    break
                elif z>=499 and z<538:
                    init(lst)
                    addfire('通信網路')
                    break
                elif z>=538 and z<634:
                    init(lst)
                    
                    addfire('電子零組件')
                    break
                
                elif z>=634 and z<659:
                    init(lst)
                    
                    addfire('電子通路')
                    break
                
                elif z>=659 and z<671:
                    init(lst)
                    
                    addfire('資訊服務')
                    break
                
                elif z>=671 and z<706:
                    init(lst)
                    
                    addfire('其他電子')
                    break
                
                elif z>=706 and z<755:
                    init(lst)
                    
                    addfire('營建')
                    break
                
                elif z>=755 and z<777:
                    init(lst)
                    
                    addfire('航運')
                    break
                elif z>=777 and z<793:
                    init(lst)
                    
                    addfire('觀光')
                    break
                elif z>=793 and z<830:
                    init(lst)
                    
                    addfire('金融')
                    break
                elif z>=830 and z<852:
                    init(lst)
                    
                    addfire('貿易百貨')
                    break
                elif z>=852 and z<860:
                    init(lst)
                    
                    addfire('油電燃氣')
                    break
                elif z>=860 and z<923:
                    init(lst)
                    
                    addfire('其他')
                    break
    
    except:
        print('Error')